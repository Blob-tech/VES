<mat-sidenav-container class="profile-sidenav">
    <mat-sidenav opened mode="side" class="sidenav" >
        <app-profile-grid [selectedUser] = "currentUser" [viewMode]="viewMode" [enabeledSocialLinks]="visibilitySettings.viewSocialProfile"
        [enabeledDetails] = "visibilitySettings.viewBasicInfo" [enabeledBio]="visibilitySettings.viewPersonalDetails"
        [enabledSubtitle] = true [mode]='mode' [bio]="bio.value"></app-profile-grid>
        </mat-sidenav>
        <!--mat-sidenav opened mode="side" position="end" class="sidenav" >
           
            </mat-sidenav-->
        
        <div class="profile-desktop-view">
            <h1 style="display:inline">{{currentUser.name.toUpperCase()}}</h1>
            <b>User Id : <span style="color : red; margin-right: 15px;">{{currentUser.user_id}}</span></b>
            <span *ngIf="viewMode != 'self' && (isInstituteAdmin()|| isSystemAdmin())">MANAGE ACCESS  <app-manage-access 
              [disabled]="!currentUser.isActivated" [access_id]="currentUser.user_id"
              [institute]="currentInstitute.organisation_id" 
              [system_admin]="isSystemAdmin()"
              ></app-manage-access></span>
            <div class="expansion-button">
                <button mat-raised-button color="primary" (click)="accordion.openAll()">
                    <mat-icon>zoom_in</mat-icon>
                    Expand All</button>
                <button mat-raised-button color="primary" (click)="accordion.closeAll()">
                    <mat-icon>zoom_out</mat-icon>
                    Collapse All</button>
              </div>

            <mat-accordion multi>
                <mat-expansion-panel *ngIf="viewMode == 'self' || visibilitySettings.viewBasicInfo">
                    <mat-expansion-panel-header>
                      <mat-panel-title>
                        <b>Basic Info </b>
                      </mat-panel-title>
                      <mat-panel-description>
                         
                          <mat-icon>info</mat-icon>
                        </mat-panel-description>
                    </mat-expansion-panel-header>
                        <form [formGroup]="basicInfoForm">
                          <button mat-button class="label-button">Name</button>
                            <mat-form-field *ngIf="viewMode == 'self'" class="form-group" appearance="outline">
                                <mat-label>User Name</mat-label>
                                <input matInput formControlName="name" required placeholder="Enter user name" >
                                <mat-hint>User name should not exceed more than 200 characters</mat-hint>
                                <mat-hint align="end">{{name.value?.length || 0}}/200</mat-hint>
                                <mat-error *ngIf="name.hasError('required')">Value is required</mat-error>
                                <mat-error *ngIf="name.hasError('maxlength')">Character Limit Exceeded</mat-error>
                            </mat-form-field>
                            <span *ngIf="viewMode == 'public'" style="font-size : 15px;"><strong>{{name.value}}</strong></span><br>
                            <button mat-button  class="label-button">Email</button>
                            <mat-form-field *ngIf="viewMode == 'self'" class="form-group" appearance="outline">
                                <mat-label>Email</mat-label>
                                <input matInput formControlName="email" required placeholder="Enter subscriber mail" >
                                <mat-hint>Please enter a valid email. This mail will be used for all future communications</mat-hint>
                                <mat-error *ngIf="email.hasError('required')">Value is required</mat-error>
                                <mat-error *ngIf="email.hasError('pattern')">Please enter a valid email in the format xyz@abc.com</mat-error>
                            </mat-form-field>
                            <span *ngIf="viewMode == 'public'" style="font-size : 15px;"><strong>{{email.value}}</strong></span><br>
                            <button mat-button  class="label-button">Contact</button>
                            <mat-form-field *ngIf="viewMode == 'self'" class="form-group" appearance="outline">
                                <mat-label>Mobile/Phone Number</mat-label>
                                 <span matPrefix>+91 &nbsp;</span>
                                <input style="width : 60%" matInput type="tel" formControlName="phone" required placeholder="Enter subscriber mobile/phone number" maxlength="10">
                                <mat-hint>Enter a 10 digit valid telephone number</mat-hint>
                                <mat-error *ngIf="phone.hasError('required')">Value is required</mat-error>
                                <mat-error *ngIf="phone.hasError('pattern')">Please enter a valid 10 digit mobile number</mat-error>
                            </mat-form-field>
                            <span *ngIf="viewMode == 'public'" style="font-size : 15px;"><strong>{{phone.value}}</strong></span><br>
                            <button mat-button  class="label-button">Address</button>
                                <mat-form-field  *ngIf="viewMode == 'self'" class="form-group" appearance="outline" style="width:90%">
                                    <mat-label>User Address</mat-label>
                                    <textarea matInput formControlName="address"  placeholder="Enter user address" ></textarea>
                                    <mat-hint>Subscriber address should not exceed more than 500 characters</mat-hint>
                                    <mat-hint align="end">{{address.value?.length || 0}}/500</mat-hint>
                                    <mat-error *ngIf="address.hasError('maxlength')">Character Limit Exceeded</mat-error>
                                </mat-form-field>
                                <span *ngIf="viewMode == 'public'" style="font-size : 15px;"><strong>{{address.value}}</strong></span><br>
                                <button *ngIf="viewMode == 'self'"  type="submit" (click)="updateBasicInfo()" mat-raised-button style="margin-right: 1rem;" color="primary"
                                [disabled]="updateBasicInfoDisabled()">Save</button>
                    
                                <button *ngIf="viewMode == 'self'" type="reset" mat-raised-button>Reset</button> 
                        </form>            
                  </mat-expansion-panel>
                <mat-expansion-panel *ngIf="(viewMode == 'self' || visibilitySettings.viewPersonalDetails)">
                  <mat-expansion-panel-header>
                    <mat-panel-title>
                      <b>Personal Details</b>
                    </mat-panel-title>
                    <mat-panel-description>
                       
                        <mat-icon>account_circle</mat-icon>
                      </mat-panel-description>
                   
                  </mat-expansion-panel-header>
                 <form [formGroup]="personalDetailsForm">
                    <button mat-button class="label-button">Bio</button>
                   <mat-form-field *ngIf="viewMode == 'self'" class="form-group"appearance="outline" style="width:90%">
                      <mat-label>Bio</mat-label>
                                    <textarea matInput formControlName="bio"  placeholder="Enter your bio" ></textarea>
                                    <mat-hint>Bio should not exceed more than 500 characters</mat-hint>
                                    <mat-hint align="end">{{bio.value?.length || 0}}/500</mat-hint>
                                    <mat-error *ngIf="bio.hasError('maxlength')">Character Limit Exceeded</mat-error>
                   </mat-form-field>
                   <span *ngIf="viewMode == 'public' && userMetas" style="font-size : 15px;"><strong>{{bio.value ? bio.value : "N/A"}}</strong></span><br>
                        <button mat-button  class="label-button">Date of Birth</button>
                        <mat-form-field *ngIf="viewMode == 'self'" class="form-group" appearance="outline">
                            <mat-label>DOB</mat-label>
                            <input  [max]="maxDate" matInput formControlName="dob"  placeholder="Choose a date" [matDatepicker]="picker">
                            <mat-datepicker-toggle  matSuffix [for]="picker"></mat-datepicker-toggle>
                            <mat-datepicker #picker></mat-datepicker>                           
                      </mat-form-field>
                      <span *ngIf="viewMode == 'public' && userMetas" style="font-size : 15px;"><strong>{{userMetas.personal_info ? (userMetas.personal_info.dob ? (userMetas.personal_info.dob.split('T')[0].substr(1) | date : 'mediumDate') : "N/A") : "N/A" }}</strong></span><br>
                        <button mat-button  class="label-button" style="display: inline;">Insterests</button>
                       <span style="display: inline;"><mat-chip-list *ngIf="viewMode == 'public'">
                            <mat-chip selected color="primary" *ngFor="let int of personalInterests" [selectable]= true>
                            {{int.interest}}
                            </mat-chip>
                        </mat-chip-list></span>
                        <mat-form-field *ngIf="viewMode == 'self'" class="form-group"appearance="outline">
                           <mat-label>Interest</mat-label>
                           <mat-chip-list #interestList >
                        <mat-chip selected color="primary" *ngFor="let interest of personalInterests" [selectable]= true
                        [removable]=true (removed)="removeInterest(interest)">
                        {{interest.interest}}
                          <mat-icon matChipRemove >cancel</mat-icon>
                        </mat-chip>
                </mat-chip-list>
                           <input  matInput 
                           [matChipInputFor]="interestList" 
                           [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
                           [matChipInputAddOnBlur]=true
                           (matChipInputTokenEnd)="addInterest($event)" placeholder="Add new interets">  
                        </mat-form-field><br>  </form>
                        

                       
                        <button mat-button  class="label-button">Gender</button> <b *ngIf="user_gender && viewMode == 'public'" style="margin-right : 15px;">{{user_gender != undefined ? user_gender : ''}}</b>
                      <mat-radio-group *ngIf="viewMode == 'self'" [(ngModel)]="user_gender" aria-label="Select an option">
                            <mat-radio-button value="MALE"><mat-icon>male</mat-icon>MALE</mat-radio-button>
                            <mat-radio-button value="FEMALE"><mat-icon>female</mat-icon>FEMALE</mat-radio-button>
                            <mat-radio-button value="TRANSGENDER"><mat-icon>transgender</mat-icon>TRANSGENDER</mat-radio-button>
                          </mat-radio-group><br><br>
                        <button *ngIf="viewMode == 'self'" mat-raised-button color="primary" (click)="savePersonalInfo()">Save</button>
                        
               

                </mat-expansion-panel>
                <mat-expansion-panel *ngIf="viewMode == 'self' || visibilitySettings.viewInstitute">
                <mat-expansion-panel-header>
                    <mat-panel-title>
                      <b>Institutes</b>
                    </mat-panel-title>
                    <mat-panel-description>
                       
                        <mat-icon>account_balance</mat-icon>
                      </mat-panel-description>
                  
                  </mat-expansion-panel-header>
                  <p *ngFor = "let role of isSysAdmin()">
                      <span style="color: cornflowerblue; display: inline; margin-right: 15px;"><b><h3>{{role.role|roleTranslate}}</h3></b></span>
                      <span *ngIf="viewMode == 'self'" style="display: inline; margin-right: 15px;">Valid Upto : <b>{{role.valid_upto ? role.valid_upto.split('T')[0] : 'Lifetime'}}</b></span>
                      <span *ngIf="!isRoleExpired(role)  && role.is_activated" style="color : green ;display: inline; margin-right: 15px;">ACTIVE</span>
                      <span *ngIf="isRoleExpired(role) " style="color :red ;display: inline; margin-right: 15px;">EXPIRED</span>
                      <span *ngIf="!role.active " style="color :orange ;display: inline; margin-right: 20px;">ACCESS REVOKED</span>
                      <span *ngIf="!isRoleExpired(role)  && role.active && !role.is_activated && role.approval == 'user'" style="color : orange ;display: inline; margin-right: 20px;">Pending approval from User</span>
                       <span *ngIf="!isRoleExpired(role) && role.active && !role.is_activated && role.approval == 'admin'" style="color : orange ;display: inline; margin-right: 20px;">Pending approval from Institute Admin</span>
                       <button mat-raised-button (click)="approveInstituteAccess(currentUser.user_id,'SADMIN','SADMIN',role.valid_upto)" color = "primary" *ngIf="!isRoleExpired(role) && !role.is_activated && role.active && role.approval == 'user' && viewMode == 'self'">
                          <mat-icon>beenhere</mat-icon> Approve Access </button><br>
                        <br>
                  </p>
                  <mat-accordion multi>
                    <mat-expansion-panel [expanded]=true *ngFor="let ins of instituteList">
                      <mat-expansion-panel-header>
                        <mat-panel-title><img height=40 width=40 src="{{ins.avatar ? imgUrl + ins.avatar : '/assets/images/insimg.png'}}"></mat-panel-title>
                        <mat-panel-description matTooltip="{{ins.organisation_name}}">{{ins.organisation_name.length < 100 ? ins.organisation_name : ins.organisation_name.substr(0,101) + '...'}}</mat-panel-description>
                      </mat-expansion-panel-header>
                        <b>Role Access</b><br>
                        <p *ngFor = "let role of getRoles(ins.organisation_id)"> 
                        <span style="color: cornflowerblue; display: inline; margin-right: 15px;"><b>{{role.role|roleTranslate}}</b></span>
                        <span  *ngIf="viewMode == 'self'" style="display: inline; margin-right: 15px;">Valid Upto : <b>{{ role.valid_upto ? role.valid_upto.split('T')[0] : 'Lifetime'}}</b></span>
                        <span *ngIf="!isRoleExpired(role)  && role.is_activated" style="color : green ;display: inline; margin-right: 15px;">ACTIVE</span>
                        <span *ngIf="isRoleExpired(role)"  style="color :red ;display: inline; margin-right: 15px;">EXPIRED</span>
                        <span *ngIf="!isRoleExpired(role)  && !role.is_activated && role.approval == 'user'" style="color : orange ;display: inline; margin-right: 20px;">Pending approval from User</span>
                       <span *ngIf="!isRoleExpired(role)  && !role.is_activated && role.approval == 'admin'" style="color : orange ;display: inline; margin-right: 20px;">Pending approval from Institute Admin</span>
                        <span *ngIf="!role.active " style="color : orange ;display: inline; margin-right: 20px;">ACCESS REVOKED</span>
                        <button mat-raised-button (click)="approveInstituteAccess(currentUser.user_id,ins.organisation_id,role.role,role.valid_upto)"color = "primary" *ngIf="!isRoleExpired(role) && !role.is_activated && role.approval == 'user' && viewMode == 'self'">
                          <mat-icon>beenhere</mat-icon> Approve Access </button><br>
                            <mat-slide-toggle *ngIf="viewMode == 'self' && role.is_activated && !isRoleExpired(role)" [(ngModel)]="ins.organisation_id == defaultInstitute"
                             (click)="setDefaultInstitute(ins.organisation_id)"
                            [disabled]="(ins.organisation_id == defaultInstitute)"></mat-slide-toggle>
                          <span *ngIf="viewMode == 'self' && role.is_activated && (!isRoleExpired(role) || ins.organisation_id == defaultInstitute)"><strong style="color: green;">{{ins.organisation_id == defaultInstitute ? "Default Institute" : "Set Default"}}</strong></span>
                      </p>
                      
                      
                    </mat-expansion-panel>
                  </mat-accordion>
                </mat-expansion-panel>
                <!--mat-expansion-panel *ngIf="(viewMode == 'self' || visibilitySettings.viewSubscriptions)">
                <mat-expansion-panel-header>
                    <mat-panel-title>
                      <b>Subscriptions</b>
                    </mat-panel-title>
                    <mat-panel-description>
                       
                        <mat-icon>subscriptions</mat-icon>
                      </mat-panel-description> 
                             
                  </mat-expansion-panel-header>
                  <p>subscription</p>
                </mat-expansion-panel-->
                <mat-expansion-panel *ngIf="(viewMode == 'self' || visibilitySettings.viewSocialProfile)">
                <mat-expansion-panel-header>
                    <mat-panel-title>
                      
                      <b>Social Profiles</b>
                    </mat-panel-title>
                    <mat-panel-description>
                       
                        <mat-icon>mood</mat-icon>
                      </mat-panel-description>
                  </mat-expansion-panel-header>
                  <mat-chip-list *ngIf="viewMode == 'public'">
                      <mat-chip 
                      selected color="primary" *ngFor="let link of socialLinks" [selectable]= true>
                      {{link.link_url}}
                      </mat-chip>
                    </mat-chip-list>
                      <mat-form-field *ngIf="viewMode == 'self'" class="form-group"appearance="outline" style="width : 90%">
                          <mat-label>Social profile links</mat-label>
                      <input matInput [(ngModel)]="newSocialLink" placeholder="Add Social Profile Link">
                      <button mat-mini-fab color="primary" matSuffix (click)="addSocialLink()">
                        <mat-icon>person_add_alt_1</mat-icon></button>
                      </mat-form-field>
                    <mat-chip-list *ngIf="viewMode == 'self'"
                        class="example-chip"
                        cdkDropList 
                        cdkDropListOrientation="horizontal"
                        (cdkDropListDropped)="dropSocialLink($event)">
                            <mat-chip class="example-box"
                            selected color="primary" cdkDrag *ngFor="let link of socialLinks" [selectable]= true
                            [removable]=true (removed)="removeSocialLink(link)">
                            {{link.link_url}}
                              <mat-icon matChipRemove >cancel</mat-icon>
                            </mat-chip>
                    </mat-chip-list><br>
                    <button *ngIf="viewMode == 'self'" mat-raised-button color="primary" (click)="saveSocialProfile()">Save</button>          
                </mat-expansion-panel>
                <mat-expansion-panel *ngIf="viewMode == 'self'">
                <mat-expansion-panel-header>
                    <mat-panel-title>
                     <b>Settings</b>
                    </mat-panel-title>
                    <mat-panel-description>
                       
                        <mat-icon>settings_suggest</mat-icon>
                      </mat-panel-description>
              
                  </mat-expansion-panel-header>
                  <mat-accordion>
                    <mat-expansion-panel>
                    <mat-expansion-panel-header>
                      <mat-panel-title>
                        <mat-icon>security</mat-icon>
                      </mat-panel-title>
                      <mat-panel-description>
                        Security
                      </mat-panel-description>
                      </mat-expansion-panel-header>
                      <button mat-button class="label-button">Change Password</button><br>
                      <div class="alert alert-success" *ngIf="changePasswordSuccess" style="width: 90%;">{{changePasswordSuccess}}</div>
                      <div class="alert alert-danger" *ngIf="changePasswordError" style="width: 90%;">{{changePasswordError}}</div><br>
                      <form [formGroup]="changePasswordForm">
                      <mat-form-field class="form-group"appearance="outline">
                          <mat-label>Current Password</mat-label>
                                        <input [type]="old_hide ? 'password' : 'text'" matInput formControlName="old_pass"  placeholder="Enter your current Password "  required>
                                        <button type="button" mat-icon-button matSuffix (click)="old_hide = !old_hide" [attr.aria-label]="'Hide password'" [attr.aria-pressed]="hide">
                                            <mat-icon>{{old_hide ? 'visibility_off' : 'visibility'}}</mat-icon>
                                            </button>
                                        <mat-hint><a href="/forgot-password">Forgot Password ?</a></mat-hint>
                                        <mat-error *ngIf="old_pass.hasError('required')">Value is required</mat-error>
                       </mat-form-field><br>
                       <mat-form-field class="form-group" appearance="outline" >
                          <mat-label>Password</mat-label>
                          <input matInput [type]="hide ? 'password' : 'text'" formControlName="password"  required placeholder="Enter user password">
                          <button type="button" mat-icon-button matSuffix (click)="hide = !hide" [attr.aria-label]="'Hide password'" [attr.aria-pressed]="hide">
                              <mat-icon>{{hide ? 'visibility_off' : 'visibility'}}</mat-icon>
                              </button>
                          <mat-error style="font-size:15px;" *ngIf="password.hasError('required')">Value is required</mat-error>
                          <mat-error *ngIf="password.hasError('minlength')">Password should be more than 8 characters</mat-error>
                          <mat-error *ngIf ="password.hasError('pattern')">Password must contain at least 1 capital letter,1 small letter, and 1 special character</mat-error>
                          <mat-error *ngIf="password.hasError('maxlength')">Password should not be more than 15 characters</mat-error>
                          
                      </mat-form-field><br>
      
                      <mat-form-field class="form-group" appearance="outline" >
                          <mat-label>Reset Password</mat-label>
                          <input matInput [type]="hide2 ? 'password' : 'text'" formControlName="resetPassword"  required placeholder="Enter user password">
                          <button type="button" mat-icon-button matSuffix (click)="hide2 = !hide2" [attr.aria-label]="'Hide password'" [attr.aria-pressed]="hide2">
                              <mat-icon>{{hide2 ? 'visibility_off' : 'visibility'}}</mat-icon>
                              </button>
                          <mat-error *ngIf="resetPassword.hasError('required')">Value is required</mat-error>
                          <mat-error *ngIf="resetPassword.hasError('notMatching')">Password doesn't matches</mat-error>
                      </mat-form-field>
                                <br>
                      <button mat-raised-button color="primary" (click)="changePassword()"
                      [disabled]="changePasswordForm.status != 'VALID'"> Change Password</button> <br><br>
                      <div class="alert alert-success" *ngIf="changePasswordSuccess" style="width: 90%;">{{changePasswordSuccess}}</div>
                      <div class="alert alert-danger" *ngIf="changePasswordError" style="width: 90%;">{{changePasswordError}}</div>
                      </form>
                    </mat-expansion-panel>
                    <mat-expansion-panel>
                        
                            <mat-expansion-panel-header>
                              <mat-panel-title>
                                <mat-icon>visibility</mat-icon>
                              </mat-panel-title>
                              <mat-panel-description>
                                Visibility
                              </mat-panel-description>
                              </mat-expansion-panel-header>
                              <div class="alert alert-info">Visibility will not be hidden to Institute Admins of your registered Institute</div>
                              <button mat-raised-button style="width : 200px; margin-right: 10px;">Basic Info </button> 
                              <mat-icon (click)="toggleVisibility('basic_info')" matTooltip="Visible" *ngIf="visibilitySettings.viewBasicInfo">visibility</mat-icon>
                              <mat-icon (click)="toggleVisibility('basic_info')" matTooltip="Not Visible" *ngIf="!visibilitySettings.viewBasicInfo">visibility_off</mat-icon><br>
                              <button mat-raised-button style="width : 200px; margin-right: 10px;">Personal Details </button> 
                              <mat-icon (click)="toggleVisibility('personal_details')" matTooltip="Visible" *ngIf="visibilitySettings.viewPersonalDetails">visibility</mat-icon>
                              <mat-icon  (click)="toggleVisibility('personal_details')"matTooltip="Not Visible" *ngIf="!visibilitySettings.viewPersonalDetails">visibility_off</mat-icon><br>
                              <button mat-raised-button style="width : 200px; margin-right: 10px;">Institute</button> 
                              <mat-icon (click)="toggleVisibility('institutes')" matTooltip="Visible" *ngIf="visibilitySettings.viewInstitute">visibility</mat-icon>
                              <mat-icon (click)="toggleVisibility('institutes')" matTooltip="Not Visible" *ngIf="!visibilitySettings.viewInstitute">visibility_off</mat-icon><br>
                              <!--button mat-raised-button style="width : 200px; margin-right: 10px;">Subscriptions</button> 
                              <mat-icon (click)="toggleVisibility('subscriptions')" matTooltip="Visible" *ngIf="visibilitySettings.viewSubscriptions">visibility</mat-icon>
                              <mat-icon (click)="toggleVisibility('subscriptions')" matTooltip="Not Visible" *ngIf="!visibilitySettings.viewSubscriptions">visibility_off</mat-icon><br-->
                              <button mat-raised-button style="width : 200px; margin-right: 10px;">Social Profile</button> 
                              <mat-icon (click)="toggleVisibility('social_profile')" matTooltip="Visible" *ngIf="visibilitySettings.viewSocialProfile">visibility</mat-icon>
                              <mat-icon (click)="toggleVisibility('social_profile')" matTooltip="Not Visible" *ngIf="!visibilitySettings.viewSocialProfile">visibility_off</mat-icon><br>
                              <button mat-raised-button style="width : 200px; margin-right: 10px;">Profile Image </button> 
                              <mat-icon  (click)="toggleVisibility('profile_image')" matTooltip="Visible" *ngIf="visibilitySettings.viewProfileImage">visibility</mat-icon>
                              <mat-icon (click)="toggleVisibility('profile_image')" matTooltip="Not Visible" *ngIf="!visibilitySettings.viewProfileImage">visibility_off</mat-icon>
                              
                            
                    </mat-expansion-panel>
                  </mat-accordion>
                  
                </mat-expansion-panel>

              </mat-accordion>
            </div>
            <div class="profile-mobile-view">
            <!--app-profile-grid [selectedUser] = "currentUser" 
            [enabledSubtitle] = true [mode]='mode' [bio]="bio.value"></app-profile-grid-->
            <app-profile-grid [selectedUser] = "currentUser" [viewMode]="viewMode" [enabeledSocialLinks]="visibilitySettings.viewSocialProfile"
            [enabeledDetails] = "visibilitySettings.viewBasicInfo" [enabeledBio]="visibilitySettings.viewPersonalDetails"
            [enabledSubtitle] = true [mode]='mode' [bio]="bio.value"></app-profile-grid>

            <h1 style="display:inline">{{currentUser.name.toUpperCase()}}</h1><br>
            <b style="margin-left : 2%">User Id : <span style="color : red">{{currentUser.user_id}}</span></b><br>
            <span *ngIf="viewMode != 'self' && (isInstituteAdmin() || isSystemAdmin())">MANAGE ACCESS  <app-manage-access 
              [disabled]="!currentUser.isActivated" [access_id]="currentUser.user_id"
              [institute]="currentInstitute.organisation_id"
              [system_admin]="isSystemAdmin()" 
              ></app-manage-access></span>
           <br><br>
            <mat-accordion multi>
                <mat-expansion-panel *ngIf="viewMode == 'self' || visibilitySettings.viewBasicInfo">
                    <mat-expansion-panel-header>
                      <mat-panel-title>
                        <b>Basic Info</b>
                      </mat-panel-title>
                      <mat-panel-description>
                         
                          <mat-icon>info</mat-icon>
                        </mat-panel-description>
                     
                    </mat-expansion-panel-header>
                        <form [formGroup]="basicInfoForm">
                          <button mat-button class="label-button">Name</button>
                            <mat-form-field *ngIf="viewMode == 'self'" class="form-group" appearance="outline">
                                <mat-label>User Name</mat-label>
                                <input matInput formControlName="name" required placeholder="Enter user name" >
                                <mat-hint>User name should not exceed more than 200 characters</mat-hint>
                                <mat-hint align="end">{{name.value?.length || 0}}/200</mat-hint>
                                <mat-error *ngIf="name.hasError('required')">Value is required</mat-error>
                                <mat-error *ngIf="name.hasError('maxlength')">Character Limit Exceeded</mat-error>
                            </mat-form-field>
                            <span *ngIf="viewMode == 'public'" style="font-size : 15px;"><strong>{{name.value}}</strong></span><br>
                            <button mat-button  class="label-button">Email</button>
                            <mat-form-field *ngIf="viewMode == 'self'" class="form-group" appearance="outline">
                                <mat-label>Email</mat-label>
                                <input matInput formControlName="email" required placeholder="Enter subscriber mail" >
                                <mat-hint>Please enter a valid email. This mail will be used for all future communications</mat-hint>
                                <mat-error *ngIf="email.hasError('required')">Value is required</mat-error>
                                <mat-error *ngIf="email.hasError('pattern')">Please enter a valid email in the format xyz@abc.com</mat-error>
                            </mat-form-field>
                            <span *ngIf="viewMode == 'public'" style="font-size : 15px;"><strong>{{email.value}}</strong></span><br>
                            <button mat-button  class="label-button">Contact</button>
                            <mat-form-field *ngIf="viewMode == 'self'" class="form-group" appearance="outline">
                                <mat-label>Mobile/Phone Number</mat-label>
                                 <span matPrefix>+91 &nbsp;</span>
                                <input style="width : 60%" matInput type="tel" formControlName="phone" required placeholder="Enter subscriber mobile/phone number" maxlength="10">
                                <mat-hint>Enter a 10 digit valid telephone number</mat-hint>
                                <mat-error *ngIf="phone.hasError('required')">Value is required</mat-error>
                                <mat-error *ngIf="phone.hasError('pattern')">Please enter a valid 10 digit mobile number</mat-error>
                            </mat-form-field>
                            <span *ngIf="viewMode == 'public'" style="font-size : 15px;"><strong>{{phone.value}}</strong></span><br>
                            
                            <button mat-button  class="label-button">Address</button>
                            <span *ngIf="viewMode == 'public'" style="font-size : 15px;"><strong>{{address.value}}</strong></span><br>
                                <mat-form-field *ngIf="viewMode == 'self'" class="form-group" appearance="outline" style="width:90%">
                                    <mat-label>User Address</mat-label>
                                    <textarea matInput formControlName="address"  placeholder="Enter user address" ></textarea>
                                    <mat-hint>Subscriber address should not exceed more than 500 characters</mat-hint>
                                    <mat-hint align="end">{{address.value?.length || 0}}/500</mat-hint>
                                    <mat-error *ngIf="address.hasError('maxlength')">Character Limit Exceeded</mat-error>
                                </mat-form-field>
                                <br>
                                
                                <button *ngIf="viewMode == 'self'"  type="submit" (click)="updateBasicInfo()" mat-raised-button style="margin-right: 1rem;" color="primary"
                                [disabled]="updateBasicInfoDisabled()">Save</button>
                    
                                <button *ngIf="viewMode == 'self'" type="reset" mat-raised-button>Reset</button> 
                        </form>            
                  </mat-expansion-panel>
                <mat-expansion-panel *ngIf="(viewMode == 'self' || visibilitySettings.viewPersonalDetails)">
                  <mat-expansion-panel-header>
                    <mat-panel-title>
                      <b>Personal Details</b>
                    </mat-panel-title>
                    <mat-panel-description>
                       
                        <mat-icon>account_circle</mat-icon>
                      </mat-panel-description>
                  
                  </mat-expansion-panel-header>
                  
                    <form [formGroup]="personalDetailsForm">
                        <button mat-button  class="label-button">Bio</button>
                        <span *ngIf="viewMode == 'public' && userMetas" style="font-size : 15px;"><strong>{{bio.value ? bio.value : "N/A"}}</strong></span><br>
                        <br>
                   <mat-form-field *ngIf="viewMode == 'self'" class="form-group"appearance="outline" style="width:90%">
                      <mat-label>Bio</mat-label>
                                    <textarea matInput formControlName="bio"  placeholder="Enter your bio" ></textarea>
                                    <mat-hint>Bio should not exceed more than 500 characters</mat-hint>
                                    <mat-hint align="end">{{bio.value?.length || 0}}/500</mat-hint>
                                    <mat-error *ngIf="bio.hasError('maxlength')">Character Limit Exceeded</mat-error>
                   </mat-form-field><br>
                        <button mat-button  class="label-button">Date of Birth</button>
                        <mat-form-field  *ngIf="viewMode == 'self'" class="form-group"appearance="outline">
                           <mat-label>DOB</mat-label>
                           <input [max]="maxDate" matInput formControlName="dob" placeholder="Choose a date" [matDatepicker]="dbpicker">
                           <mat-datepicker-toggle  matSuffix [for]="dbpicker"></mat-datepicker-toggle>
                           <mat-datepicker #dbpicker></mat-datepicker>   
                        </mat-form-field>
                        <span *ngIf="viewMode == 'public' && userMetas" style="font-size : 15px;"><strong>{{userMetas.personal_info ? ( userMetas.personal_info.dob ? (userMetas.personal_info.dob.split('T')[0].substr(1) | date : 'mediumDate') : "N/A") : "N/A"}}</strong></span><br>
                        <button mat-button class="label-button" style="display: inline;">Insterests</button>
                        <span style="display: inline;"><mat-chip-list *ngIf="viewMode == 'public'">
                            <mat-chip selected color="primary" *ngFor="let interest of personalInterests" [selectable]= true>
                            {{interest.interest}}
                            </mat-chip>
                        </mat-chip-list></span>
                        <mat-form-field *ngIf="viewMode == 'self'" class="form-group"appearance="outline">
                           <mat-label>Interests</mat-label>
                           <mat-chip-list  #interestList >
                        <mat-chip selected color="primary" *ngFor="let interest of personalInterests" [selectable]= true
                        [removable]=true (removed)="removeInterest(interest)">
                        {{interest.interest}}
                          <mat-icon matChipRemove >cancel</mat-icon>
                        </mat-chip>
                </mat-chip-list>
                           <input  matInput 
                           [matChipInputFor]="interestList" 
                           [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
                           [matChipInputAddOnBlur]=true
                           (matChipInputTokenEnd)="addInterest($event)" placeholder="Add new interets">  
                        </mat-form-field><br>
                      </form>
                      <button mat-button  class="label-button">Gender</button>
                      <b *ngIf="user_gender && viewMode == 'public'" style="margin-right : 15px;">{{user_gender != undefined ? user_gender : ''}}</b><br>
                      <mat-radio-group *ngIf="viewMode == 'self'" [(ngModel)]="user_gender" aria-label="Select an option">
                          <mat-radio-button value="MALE"><mat-icon>male</mat-icon>MALE</mat-radio-button><br>
                          <mat-radio-button value="FEMALE"><mat-icon>female</mat-icon>FEMALE</mat-radio-button><br>
                          <mat-radio-button value="TRANSGENDER"><mat-icon>transgender</mat-icon>TRANSGENDER</mat-radio-button>
                        </mat-radio-group><br><br>
                       
                        <button *ngIf="viewMode == 'self'" mat-raised-button color="primary" (click)="savePersonalInfo()">Save</button>
                        
                        
              

                </mat-expansion-panel>
                <mat-expansion-panel *ngIf="viewMode == 'self' || visibilitySettings.viewInstitute">
                <mat-expansion-panel-header>
                    <mat-panel-title>
                      <b>Institutes</b>
                    </mat-panel-title>
                    <mat-panel-description>
                       
                        <mat-icon>account_balance</mat-icon>
                      </mat-panel-description>
                   
                  </mat-expansion-panel-header>
                  <p *ngFor = "let role of isSysAdmin()">
                      <span style="color: cornflowerblue; display: inline; margin-right: 15px;"><b><h3>{{role.role|roleTranslate}}</h3></b></span>
                      <span style="display: inline; margin-right: 15px;">Valid Upto : <b>{{role.valid_upto ? role.valid_upto.split('T')[0] : 'Lifetime'}}</b></span>
                      <span *ngIf="!isRoleExpired(role)  && role.is_activated" style="color : green ;display: inline; margin-right: 15px;">ACTIVE</span>
                      <span *ngIf="isRoleExpired(role)" style="color :red ;display: inline; margin-right: 15px;">EXPIRED</span>
                      <span *ngIf="!role.active" style="color :orange ;display: inline; margin-right: 20px;">ACCESS REVOKED</span>
                      <span *ngIf="!isRoleExpired(role)  && role.active && !role.is_activated && role.approval == 'user'" style="color : orange ;display: inline; margin-right: 20px;">Pending approval from User</span>
                      <span *ngIf="!isRoleExpired(role)  && role.active && !role.is_activated && role.approval == 'admin'" style="color : orange ;display: inline; margin-right: 20px;">Pending approval from Institute Admin</span>
                      <button mat-raised-button (click)="approveInstituteAccess(currentUser.user_id,'SADMIN','SADMIN',role.valid_upto)" color = "primary" *ngIf="!isRoleExpired(role) && !role.is_activated && role.active && role.approval == 'user' && viewMode == 'self'">
                          <mat-icon>beenhere</mat-icon> Approve Access </button><br>
                        <br>
                      
                  </p>                  <mat-accordion multi>
                      <mat-expansion-panel [expanded]=true *ngFor="let ins of instituteList">
                        <mat-expansion-panel-header>
                          <mat-panel-title><img height=40 width=40 src="{{ins.avatar ? imgUrl + ins.avatar : '/assets/images/insimg.png'}}"></mat-panel-title>
                          <mat-panel-description>{{ins.client_id}}</mat-panel-description>
                        </mat-expansion-panel-header>
                        <b style="color : cornflowerblue">{{ins.organisation_name}}</b><br>
                        <b>Role Access</b><br>
                        <p *ngFor = "let role of getRoles(ins.organisation_id)"> 
                        <span style="color: cornflowerblue; display: inline; margin-right: 15px;"><b>{{role.role | roleTranslate}}</b></span>
                        <span *ngIf="viewMode == 'self'" style="display: inline; margin-right: 15px;">Valid Upto : <b>{{role.valid_upto ? role.valid_upto.split('T')[0] : 'Lifetime'}}</b></span>
                        <span *ngIf="!isRoleExpired(role)  && role.is_activated" style="color : green ;display: inline; margin-right: 15px;">ACTIVE</span>
                        <span *ngIf="isRoleExpired(role) " style="color :red ;display: inline; margin-right: 15px;">EXPIRED</span>
                        <span *ngIf="!isRoleExpired(role)  && role.active && !role.is_activated && role.approval == 'user'" style="color : orange ;display: inline; margin-right: 20px;">Pending approval from User</span>
                       <span *ngIf="!isRoleExpired(role)  && role.active && !role.is_activated && role.approval == 'admin'" style="color : orange ;display: inline; margin-right: 20px;">Pending approval from Institute Admin</span>
                        <span *ngIf="!role.active " style="color : orange ;display: inline; margin-right: 20px;">ACCESS REVOKED</span><br>
                        <button mat-raised-button (click)="approveInstituteAccess(currentUser.user_id,ins.organisation_id,role.role,role.valid_upto)" color = "primary" *ngIf="!isRoleExpired(role) && !role.is_activated && role.active && role.approval == 'user' && viewMode == 'self'">
                          <mat-icon>beenhere</mat-icon> Approve Access </button><br>
                        <br>
                           
                            
                        <mat-slide-toggle *ngIf="viewMode == 'self' && role.is_activated && !isRoleExpired(role)" [(ngModel)]="ins.organisation_id == defaultInstitute"
                        (click)="setDefaultInstitute(ins.organisation_id)"
                       [disabled]="(ins.organisation_id == defaultInstitute)"></mat-slide-toggle>
                     <span *ngIf="viewMode == 'self' && role.is_activated && (!isRoleExpired(role) || ins.organisation_id == defaultInstitute)"><strong style="color: green;">{{ins.organisation_id == defaultInstitute ? "Default Institute" : "Set Default"}}</strong></span>
                      </p>
                      
                      </mat-expansion-panel>
                    </mat-accordion>
                </mat-expansion-panel>
                <!--mat-expansion-panel *ngIf="viewMode == 'self' || visibilitySettings.viewSubscriptions">
                <mat-expansion-panel-header>
                    <mat-panel-title>
                      <b>Subscriptions</b>
                    </mat-panel-title>
                    <mat-panel-description>
                       
                        <mat-icon>subscriptions</mat-icon>
                      </mat-panel-description> 
                           
                  </mat-expansion-panel-header>
                  <p>subscription</p>
                </mat-expansion-panel-->
                <mat-expansion-panel *ngIf="(viewMode == 'self' || visibilitySettings.viewSocialProfile)">
                <mat-expansion-panel-header>
                    <mat-panel-title>
                      <b>Social Profiles</b>
                    </mat-panel-title>
                    <mat-panel-description>
                       
                        <mat-icon>mood</mat-icon>
                      </mat-panel-description>
                    
                  </mat-expansion-panel-header>
                  <mat-chip-list *ngIf="viewMode == 'public'">
                      <mat-chip selected color="primary" *ngFor="let link of socialLinks" [selectable]= true
                      >
                      {{link.link_url}}
                      
                      </mat-chip>
                  </mat-chip-list>
                  <mat-form-field *ngIf="viewMode == 'self'" class="form-group"appearance="outline" style="width : 90%">
                      <mat-label>Social profile links</mat-label>
                  <input matInput [(ngModel)]="newSocialLink" placeholder="Add Social Profile Link">
                  <button mat-mini-fab color="primary" matSuffix (click)="addSocialLink()">
                    <mat-icon>person_add_alt_1</mat-icon></button>
                  </mat-form-field>
                <mat-chip-list  *ngIf="viewMode == 'self'"
                    cdkDropList 
                    cdkDropListOrientation="horizontal"
                    (cdkDropListDropped)="dropSocialLink($event)">
                        <mat-chip selected color="primary" cdkDrag *ngFor="let link of socialLinks" [selectable]= true
                        [removable]=true (removed)="removeSocialLink(link)">
                        {{link.link_url}}
                          <mat-icon matChipRemove >cancel</mat-icon>
                        </mat-chip>
                </mat-chip-list><br>
                <button *ngIf="viewMode == 'self'" mat-raised-button color="primary" (click)="saveSocialProfile()">Save</button>
                </mat-expansion-panel>
                <mat-expansion-panel *ngIf="viewMode == 'self'">
                <mat-expansion-panel-header>
                    <mat-panel-title>
                     <b>Settings</b>
                    </mat-panel-title>
                    <mat-panel-description>
                       
                        <mat-icon>settings_suggest</mat-icon>
                      </mat-panel-description>
                    
                  </mat-expansion-panel-header>
                  <mat-accordion>
                      <mat-expansion-panel>
                      <mat-expansion-panel-header>
                        <mat-panel-title>
                          <mat-icon>security</mat-icon>
                        </mat-panel-title>
                        <mat-panel-description>
                          Security
                        </mat-panel-description>
                        </mat-expansion-panel-header>
                        <button mat-button class="label-button">Change Password</button><br>
                        <div class="alert alert-success" *ngIf="changePasswordSuccess" style="width: 90%;">{{changePasswordSuccess}}</div>
                        <div class="alert alert-danger" *ngIf="changePasswordError" style="width: 90%;">{{changePasswordError}}</div><br>
                        <form [formGroup]="changePasswordForm">
                        <mat-form-field class="form-group"appearance="outline">
                            <mat-label>Current Password</mat-label>
                                          <input [type]="old_hide ? 'password' : 'text'" matInput formControlName="old_pass"  placeholder="Enter your current Password "  required>
                                          <button type="button" mat-icon-button matSuffix (click)="old_hide = !old_hide" [attr.aria-label]="'Hide password'" [attr.aria-pressed]="hide">
                                              <mat-icon>{{old_hide ? 'visibility_off' : 'visibility'}}</mat-icon>
                                              </button>
                                          <mat-hint><a href="/forgot-password">Forgot Password ?</a></mat-hint>
                                          <mat-error *ngIf="old_pass.hasError('required')">Value is required</mat-error>
                         </mat-form-field><br>
                         <mat-form-field class="form-group" appearance="outline" >
                            <mat-label>Password</mat-label>
                            <input matInput [type]="hide ? 'password' : 'text'" formControlName="password"  required placeholder="Enter user password">
                            <button type="button" mat-icon-button matSuffix (click)="hide = !hide" [attr.aria-label]="'Hide password'" [attr.aria-pressed]="hide">
                                <mat-icon>{{hide ? 'visibility_off' : 'visibility'}}</mat-icon>
                                </button>
                            <mat-error style="font-size:15px;" *ngIf="password.hasError('required')">Value is required</mat-error>
                            <mat-error *ngIf="password.hasError('minlength')">Password should be more than 8 characters</mat-error>
                            <mat-error *ngIf ="password.hasError('pattern')">Password must contain at least 1 capital letter,1 small letter, and 1 special character</mat-error>
                            <mat-error *ngIf="password.hasError('maxlength')">Password should not be more than 15 characters</mat-error>
                            
                        </mat-form-field><br>
        
                        <mat-form-field class="form-group" appearance="outline" >
                            <mat-label>Reset Password</mat-label>
                            <input matInput [type]="hide2 ? 'password' : 'text'" formControlName="resetPassword"  required placeholder="Enter user password">
                            <button type="button" mat-icon-button matSuffix (click)="hide2 = !hide2" [attr.aria-label]="'Hide password'" [attr.aria-pressed]="hide2">
                                <mat-icon>{{hide2 ? 'visibility_off' : 'visibility'}}</mat-icon>
                                </button>
                            <mat-error *ngIf="resetPassword.hasError('required')">Value is required</mat-error>
                            <mat-error *ngIf="resetPassword.hasError('notMatching')">Password doesn't matches</mat-error>
                        </mat-form-field>
                                  <br>
                        <button mat-raised-button color="primary" (click)="changePassword()"
                        [disabled]="changePasswordForm.status != 'VALID'"> Change Password</button> <br><br>
                        <div class="alert alert-success" *ngIf="changePasswordSuccess" style="width: 90%;">{{changePasswordSuccess}}</div>
                        <div class="alert alert-danger" *ngIf="changePasswordError" style="width: 90%;">{{changePasswordError}}</div>
                        </form>
                      </mat-expansion-panel>
                      <mat-expansion-panel>
                          <mat-expansion-panel-header>
                            <mat-panel-title>
                              <mat-icon>visibility</mat-icon>
                            </mat-panel-title>
                            <mat-panel-description>
                              Visibility
                            </mat-panel-description>
                            </mat-expansion-panel-header>
                            <div class="alert alert-info">Visibility will not be hidden to Institute Admins of your registered Institute</div>
                            <button mat-raised-button style="width : 200px; margin-right: 10px;">Basic Info </button> 
                            <mat-icon (click)="toggleVisibility('basic_info')" matTooltip="Visible" *ngIf="visibilitySettings.viewBasicInfo">visibility</mat-icon>
                            <mat-icon (click)="toggleVisibility('basic_info')" matTooltip="Not Visible" *ngIf="!visibilitySettings.viewBasicInfo">visibility_off</mat-icon><br>
                            <button mat-raised-button style="width : 200px; margin-right: 10px;">Personal Details </button> 
                            <mat-icon (click)="toggleVisibility('personal_details')" matTooltip="Visible" *ngIf="visibilitySettings.viewPersonalDetails">visibility</mat-icon>
                            <mat-icon  (click)="toggleVisibility('personal_details')"matTooltip="Not Visible" *ngIf="!visibilitySettings.viewPersonalDetails">visibility_off</mat-icon><br>
                            <button mat-raised-button style="width : 200px; margin-right: 10px;">Institute</button> 
                            <mat-icon (click)="toggleVisibility('institutes')" matTooltip="Visible" *ngIf="visibilitySettings.viewInstitute">visibility</mat-icon>
                            <mat-icon (click)="toggleVisibility('institutes')" matTooltip="Not Visible" *ngIf="!visibilitySettings.viewInstitute">visibility_off</mat-icon><br>
                            <!--button mat-raised-button style="width : 200px; margin-right: 10px;">Subscriptions</button> 
                            <mat-icon (click)="toggleVisibility('subscriptions')" matTooltip="Visible" *ngIf="visibilitySettings.viewSubscriptions">visibility</mat-icon>
                            <mat-icon (click)="toggleVisibility('subscriptions')" matTooltip="Not Visible" *ngIf="!visibilitySettings.viewSubscriptions">visibility_off</mat-icon><br-->
                            <button mat-raised-button style="width : 200px; margin-right: 10px;">Social Profile</button> 
                            <mat-icon (click)="toggleVisibility('social_profile')" matTooltip="Visible" *ngIf="visibilitySettings.viewSocialProfile">visibility</mat-icon>
                            <mat-icon (click)="toggleVisibility('social_profile')" matTooltip="Not Visible" *ngIf="!visibilitySettings.viewSocialProfile">visibility_off</mat-icon><br>
                            <button mat-raised-button style="width : 200px; margin-right: 10px;">Profile Image </button> 
                            <mat-icon  (click)="toggleVisibility('profile_image')" matTooltip="Visible" *ngIf="visibilitySettings.viewProfileImage">visibility</mat-icon>
                            <mat-icon (click)="toggleVisibility('profile_image')" matTooltip="Not Visible" *ngIf="!visibilitySettings.viewProfileImage">visibility_off</mat-icon>
                            
                          </mat-expansion-panel>
                    </mat-accordion>
                    
                  
                </mat-expansion-panel>

              </mat-accordion>
            </div>
</mat-sidenav-container>
<div *ngIf="showLoader" class="loader">
  <mat-spinner color="primary"></mat-spinner><br>
  <span style="color: white; position: fixed; top:400px">Loading ...</span>
  </div>
